<!DOCTYPE html>
<html prefix="og: https://ogp.me/ns#" lang="en">

  <head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="">

  <title>Update on the Layer Based SVG Engine (LBSE) in WebKit</title>
  <link rel="canonical" href="https://igalia.github.io/wpewebkit.org/update-11ty/blog/status-of-lbse-in-webkit.html">
  <link rel="alternate" type="application/rss+xml" title="" href="https://igalia.github.io/wpewebkit.org/update-11ty/feed.xml">
  <link rel="alternate" type="application/rss+xml" title="WPE blog" href="https://igalia.github.io/wpewebkit.org/update-11ty/blog.xml">
  <meta property="og:url" content="https://igalia.github.io/wpewebkit.org/update-11ty/blog/status-of-lbse-in-webkit.html">
  <meta property="og:title" content="Update on the Layer Based SVG Engine (LBSE) in WebKit">
  <meta property="og:image" content="https://igalia.github.io/wpewebkit.org/update-11ty/assets/twitter_Profile_WhiteBg_400px.png">
  <meta property="og:image:secure_url" content="https://igalia.github.io/wpewebkit.org/update-11ty/assets/twitter_Profile_WhiteBg_400px.png">
  <meta property="og:image:alt" content="WPE logo">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="400">
  <meta property="og:image:height" content="400">
  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2024-05-21T00:00:00.000Z">
  <meta property="article:tag" content="blogpost">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@WPEWebKit">

  <!-- CSS v2 -->
  <link rel="stylesheet" href="/wpewebkit.org/update-11ty/css/v2.css">

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="/wpewebkit.org/update-11ty/vendor/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/wpewebkit.org/update-11ty/css/fonts.css">

  <!-- Code syntax highlighting -->
  <link rel="stylesheet" href="/wpewebkit.org/update-11ty/css/prism.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/wpewebkit.org/update-11ty/css/stylish-portfolio.css">
  <script type="text/javascript">
    window.addEventListener('load',function() {document.querySelector('nav.global>div>.burger').addEventListener('click',menutog)});
    function menutog(e) {
      document.querySelector('nav.global>div>ul').classList.toggle('off');
      e.preventDefault();
    }
  </script>
  <!-- Matomo -->
  <script type="text/javascript">
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//stats.igalia.com/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '6']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->
</head>


  <body id="page-top" class="subpage">

    <nav class="global">
	<div>
		<a class="igalia logo home" href="/wpewebkit.org/update-11ty/"><img src="/wpewebkit.org/update-11ty/assets/img/logo-blue.svg" alt="WPE"></a>
		<ul class="blog off"><li>
			<a class="nav-link" href="/wpewebkit.org/update-11ty/">Home</a>
			</li><li>
			<a class="nav-link" href="/wpewebkit.org/update-11ty/about/">Learn & Discover</a>
			</li><li class="currentPage">
			<a class="nav-link" href="/wpewebkit.org/update-11ty/blog/">Blog</a>
			</li><li>
			<a class="nav-link" href="/wpewebkit.org/update-11ty/developers/">Developers</a>
			</li><li>
			<a class="btn cta" href="/wpewebkit.org/update-11ty/about/get-wpe.html">Get WPE</a>
			</li></ul>
		<a href="#" class="burger">Menu</a>
	</div>
</nav>


    <main>
    <style>
header.page h1 {
	margin-bottom: 0.33em;
	line-height: 1;
}
header.page time {
	font-size: 1.25em;
	opacity: 0.67;
}
header.page .btn-xl {
	padding: 1em 2em;
  margin-left: 0.5em;
}
</style>
<div itemscope="" itemtype="http://schema.org/TechArticle">
<meta itemprop="creativeWorkStatus" content="Published">
<meta itemprop="isAccessibleForFree" content="True">
<meta itemprop="publisher" content="WPE Team">
<meta itemprop="author" content="WPE Team">
<meta itemprop="url" content="https://igalia.github.io/wpewebkit.org/update-11ty/blog/status-of-lbse-in-webkit.html">

<header class="page full-bleed">
 <h1 itemprop="headline">Update on the Layer Based SVG Engine (LBSE) in WebKit</h1>
 
   <meta itemprop="datePublished" content="Tue May 21 2024">
   <time itemprop="dateCreated">21 May 2024</time>
 
  
</header>

<div itemprop="articleBody">

<p>This blog entry gives an update on what we at <a href="https://www.igalia.com">Igalia</a> have done on upstreaming and development of LBSE in WebKit in the last seven months. For an explanation of
what LBSE is and how it is related to WPE, see this <a href="https://wpewebkit.org/blog/05-new-svg-engine.html">previous entry</a> as a refresher.</p>
<div style="float: right">
<figure>
  <a class="btn" href="https://www.igalia.com" target="_blank"><img style="display: block; height: 100px;" src="/wpewebkit.org/update-11ty/assets/svg/igalia-tagline.svg" alt="The Igalia logo">
  </a>
</figure>
<figure>
  <a class="btn" href="https://wix.com" target="_blank"><img style="display: block; height: 60px;" src="/wpewebkit.org/update-11ty/assets/svg/wix-logo.svg" alt="The Wix logo">
  </a>
</figure>
</div>
<p>Thanks to generous funding by <a href="https://www.wix.com" alt="Wix homepage"><b>Wix</b></a>, which extensively uses SVG in their products and has a broad
knowledge of the SVG peculiarities across browser engines, LBSE has made great progress in the past seven months. During this period, several advanced SVG painting
features were implemented (e.g. clip-paths, masks, gradients, patterns), along with important performance improvements that expanded the new engine’s capabilities
and stability. All this was possible thanks to Wix’s decision to address their problems by funding upstream work at the core of WebKit, instead of accepting
the status-quo and implementing case-by-case fixes and workarounds on their end. As a result, WebKit-based browsers now benefit from the results of this fruitful
collaboration, which we’ll try to explain in more detail in this blog post.</p>
<h2 id="project-kick-off-and-webkit-contributors-meeting" tabindex="-1">Project kick off and WebKit Contributors Meeting</h2>
<p>In <strong>October 2023</strong> we started the project mostly by thinking about the design and roadmap. We also did some general SVG bug fixing. For example, visual overflow computation for SVG renderers was <a href="https://commits.webkit.org/268981@main">corrected</a>, which fixed quite a few SVG pixel tests. Various visual bugs were also fixed, such as <a href="https://commits.webkit.org/269034@main">unnecessary repainting when <code>viewBox</code> is used on &lt;svg&gt; elements</a>, and <a href="https://commits.webkit.org/269360@main">incorrect clipping for outermost &lt;svg&gt; elements</a></p>
<p>Also in the same month, we attended the <a href="https://docs.webkit.org/Other/Contributor%20Meetings/ContributorMeeting2023.html">WebKit Contributors Meeting</a>, where we presented a talk on the LBSE (<a href="https://www.slideshare.net/igalia/integrating-the-new-layerbased-svg-engine">slides are available here</a>). The feedback on LBSE at the meeting was very positive. Giving the talk early on in the process actually helped us since we needed to have a good design in place.</p>
<h2 id="supporting-svg-resources" tabindex="-1">Supporting SVG resources</h2>
<p>The main focus in <strong>October 2023</strong> was introducing the SVG resource concept, as already outlined in the WebKit Contributors Meeting talk. Thus, we started with <a href="https://commits.webkit.org/269522@main">adding a base SVG resource class: <code>RenderSVGResourceContainer</code> </a>. This class was kept as simple as possible, with no support for resource invalidation or repainting logic. The main task of <code>RenderSVGResourceContainer</code> is to take care of registration so that the resource can be looked up by its clients.</p>
<p>For the first SVG resource to implement, we chose the SVG &lt;clip-path&gt; element, so we landed <a href="https://commits.webkit.org/269635@main"><code>RenderSVGResourceClipper</code></a>. To comply with the specification, the <code>RenderSVGResourceClipper</code> implementation produces 1-bit masks and uses a special rendering mode:</p>
<ul>
<li><code>fill-opacity</code>/<code>stroke-opacity</code>/<code>opacity</code> set to <code>1</code></li>
<li>masker/filter not applied when rendering the children</li>
<li><code>fill</code> set to solid black and <code>stroke</code> set to <code>none</code></li>
</ul>
<p>The initial implementation did not use caching of ImageBuffers for clipping, but relied on Porter-Duff DestinationIn/SourceOver compositing operations to achieve the same effect, but faster. By integrating <code>RenderSVGResourceClipper</code> properly into <code>RenderLayer</code>, it aligned SVG clipping with HTML/CSS clipping.</p>
<p>Finally, the implementation prefers a pure clipping solution internally, as in legacy rendering, but for more complicated clip-paths (for example when the clip-path involves text content), a fallback to a mask is done.</p>
<h2 id="resource-invalidation-handling" tabindex="-1">Resource invalidation handling</h2>
<p>After introducing the first SVG resource (<code>RenderSVGResourceClipper</code>), we noticed some issues with handling invalidations for it, such as adding to clip-path contents. In the legacy engine, invalidations have been handled through layouting. This caused various problems: for one, it could cause calling the <code>setNeedsLayout</code> method from within layout, which meant the invalidation chain depended on the DOM order.</p>
<p>In <strong>November 2023</strong>, <a href="https://commits.webkit.org/271017@main">an implementation landed</a> that avoided using layout for resource invalidation. Instead, on dynamic updates, the style system is used to determine the appropriate action:</p>
<ul>
<li>For non resources, changes that cause renderer geometry changes, like changing the <code>x</code> value of a &lt;rect&gt; element, still require a relayout. For visual changes not affecting geometry, like changing the fill color of a &lt;rect&gt;, a repaint action is enough.</li>
<li>For resources, the resource is invalidated/updated with the change and any of its clients are repainted using the new resource.</li>
</ul>
<h2 id="support-for-masks" tabindex="-1">Support for masks</h2>
<p>With improved support for SVG resource invalidation, in <strong>late November 2023</strong> we were ready to upstream support for the next SVG resource, <a href="https://commits.webkit.org/271153@main">RenderSVGResourceMasker</a>.</p>
<p>Like the support for clip-path, <code>RenderSVGResourceMasker</code> started out without caching image buffers and relied on creating temporary image buffers at rendering time. Mask content invalidations/changes were supported out of the box since we had improved resource invalidation handling (see above).</p>
<h2 id="support-for-gradients" tabindex="-1">Support for gradients</h2>
<p>In early <strong>January 2024</strong>, <a href="https://commits.webkit.org/272653@main">support for SVG gradients was upstreamed</a>. Gradients are a kind of SVG resource that is a bit different to the previously implemented clipping paths and masks because it is a <a href="https://www.w3.org/TR/SVG2/pservers.html">paint server</a>, so a helper class for that called <code>SVGPaintServerHandling</code> and a base class <code>RenderSVGResourcePaintServer</code> were introduced. The main difference is in invalidation: paint servers simply need a repaint of all its clients on invalidation, whereas clipping paths/masks may need to do more work; i.e., masks underlying image buffers need to be updated before its clients can be repainted.</p>
<h2 id="support-for-patterns-and-markers" tabindex="-1">Support for patterns and markers</h2>
<p>By the end of <strong>January 2024</strong>, <a href="https://commits.webkit.org/273757@main">support for SVG patterns was upstreamed</a>. In the first implementation, no image buffer caching was implemented in order to keep things clean and simple. This implementation is different from the legacy implementation because the pattern contents are being rendered through pattern content layers (see <a href="https://github.com/WebKit/WebKit/blob/main/Source/WebCore/rendering/RenderLayer.cpp#L2846"><code>RenderLayer::paintSVGResourceLayer</code></a>). To make this work, <code>RenderSVGResourcePattern</code> has to set up the graphics context matrix correctly before calling <code>paintSVGResourceLayer</code>.</p>
<p>Around that same time, we implemented the next to last SVG resource on our TODO list, namely <a href="https://commits.webkit.org/273820@main">SVG markers</a>.</p>
<h2 id="svg-filters" tabindex="-1">SVG filters</h2>
<p>In <strong>February 2024</strong>, Apple started work on <a href="https://github.com/WebKit/WebKit/pull/25087">supporting SVG filters</a> in LBSE. A first iteration managed to fix a lot of the official SVG filter tests, but it turned out a <a href="https://github.com/WebKit/WebKit/pull/25512">filter regression</a> had to be fixed first. Moreover, the initial work uncovered issues with the HTML/CSS filters implementation that need to be fixed in general. Finally, another reason why this support takes more time than some other features is that there is a strong requirement to make the support efficient in both memory usage and overall (re)painting speed. Still, the early results are very promising!</p>
<h2 id="cycle-detection" tabindex="-1">Cycle detection</h2>
<p>It is quite easy in SVG to cause direct circular references:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defs</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>p<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xlink:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#p<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>defs</span><span class="token punctuation">></span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span></code></pre>
<p>It is also possible to cause indirect circular references:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defs</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mask</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>z<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#z)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mask</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>defs</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ellipse</span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#z)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span></code></pre>
<p>The legacy engine solved this in an ad-hoc way in various places in the engine; it tried to break cycles before rendering, but still needed cycle protections in various places, since the solution was never unified or complete.</p>
<p>In <strong>February 2024</strong> we provided a unified solution for LBSE by introducing <code>SVGVisitedRendererTracking</code>; <a href="https://commits.webkit.org/274392@main">see this commit</a> for more. In the new approach, we don’t attempt to remove cycles, but detect them everywhere upon usage and stop processing in well-defined ways, all centralized in <code>SVGVisitedRendererTracking</code>.</p>
<h2 id="nested-mask%2Fpattern-slowness" tabindex="-1">Nested mask/pattern slowness</h2>
<p>In <strong>April 2024</strong>, we addressed the slowness problems with nested masks/patterns. As an example, consider this for nested masks:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defs</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mask</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>z<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#y)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#y)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            ...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mask</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mask</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>y<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#x)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#x)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            ...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mask</span><span class="token punctuation">></span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>defs</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ellipse</span> <span class="token attr-name">mask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url(#z)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span></code></pre>
<p>For this example, the complexity can be increased at will by adding more masks and contents per mask.</p>
<p>The solution was twofold:</p>
<ul>
<li>For masks, we realized bounding box calculations for a mask were not affected by masks used in the mask contents, so we could cut off bounding box calculations for nested masks.</li>
<li>For both masks and patterns, we added caching of image buffers per resource client so nested masks/patterns that are already encountered can reuse the image buffer cache.</li>
</ul>
<p>See optimizations here for nested <a href="https://commits.webkit.org/273820@main">masks</a> and <a href="https://commits.webkit.org/277306@main">patterns</a>.</p>
<h2 id="next-steps" tabindex="-1">Next steps</h2>
<p>For the short and mid-term, the plan is to make LBSE at least as good as legacy in regards to test coverage; i.e., all tests that pass in legacy should pass in LBSE. We have made a lot of progress over the
last seven months just because of the amount of SVG resources that were implemented, but for example ,we will need to have SVG filters in place to pass this goal.</p>
<p>Another goal is to make sure LBSE passes all security requirements, as failing that would be a blocker to replacing the current engine. Fortunately, we are already taking this into account in several ways, such as adopting a lot of good <a href="https://github.com/WebKit/WebKit/wiki/Smart-Pointer-Usage-Guidelines">smart pointer practices</a>.</p>
<p>Finally, a big goal will be for LBSE to perform well on certain benchmarks like <a href="https://browserbench.org/MotionMark1.2/">MotionMark</a>, since WebKit has a golden rule to never ship a performance regression. So far there has not been an explicit focus
on performance, and we know there are likely optimizations possible in <code>RenderLayer</code> usage, both in reducing the number of <code>RenderLayer</code> objects we create in certain situations as well as a possible reduction in complexity of <code>RenderLayer</code> for LBSE usage.</p>
<p>All in all, we are very pleased with the results and the progress we made in the last seven months. We at <a href="https://www.igalia.com">Igalia</a> look forward to finishing the work to get the new engine in a shippable state in the near future!</p>



<section class="content-section bg-light small-section">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 mx-auto text-muted text-left align-text-top">
        <hr class="author-line">
        <div class="card">
          <span>
            This article was written by <a href="https://www.igalia.com/team/rbuis">Rob Buis</a>. <br><br>Longtime WebKit/Blink hacker with a preference for open source.
          </span>
        </div>
      </div>
    </div>
  </div>
</section>



</div>

    <div class="survey">
    <p>
    If you’re using WPE WebKit, or are considering doing so, <strong><a href="https://docs.google.com/forms/d/e/1FAIpQLSchPgMGzuVc9ry5bdxF2uFnW2q3FcrSSqxJdOM4Fd2BD4s7dg/viewform?usp=pp_url&amp;entry.1179679285=WPEWebKit.org+website">please take our brief user survey</a></strong>. Your input will help us make WPE WebKit better for you!
    </p>
    </div>
    <style>
    .survey {
    position: relative;
    padding-block: 2em 3em;
    margin-block: 3em 0;
    --bgrad: linear-gradient(180deg,#00C6 0.25em,#00B4 20%,40%,#00B2);
    background: var(--bgrad);
    border-image: var(--bgrad) 1;
    border-image-outset: 0 50vmax;
    border-image-width: 0 50vmax;
    font-size: 1.25em;
    }
    .survey::before {
    content: url(/assets/img/survey.svg);
    position: absolute;
    top: -1.5em;
    left: 0;
    right: 0;
    margin-inline: auto;
    height: 3em;
    width: auto;
    aspect-ratio: 1/1;
    filter: drop-shadow(0.25em 0.33em 0.33em #0006);
    }
    .survey p {
    padding-inline: 1em;
    }
    </style>

    </div></main>

    <dialog id="splash">
<p>If you’re using WPE WebKit, or are considering doing so, <strong>please take our brief user survey!</strong> Your input will help us make WPE WebKit better for you.</p>
<div>
<button is="dis-misser" id="dismiss-Y">Yes</button>
<button is="dis-misser" id="dismiss-L">Ask again later</button>
<button is="dis-misser" id="dismiss-N">No</button>
</div>
</dialog>
<style>
#splash {max-width: 50%; border-radius: 1em; padding-inline: 2em; outline: 50vmax solid #141316D0; background: #EEE;}
#splash p {font-size: 1.25em; color: inherit;}
#splash img {max-width: 60vw; max-height: 50vh; aspect-ratio: 1.88/1;}
@media (max-width: 600px) {
	#splash img {object-fit: contain; object-position: 100% 100%;}
}
#splash div {margin-block: 1em 1.5em; text-align: center; display: flex; gap: 1em; justify-content: center;}
#splash button {font-size: 1.33em; border-radius: 1em; padding-inline: 0.75em; padding-block: 0.2em; border: 0; background: #888; color: #EEE; cursor: pointer;}
#splash button:focus {outline: 0.25em solid black;}
#splash button#dismiss-Y {background: hsl(205deg 84.8% 50%);}
#splash button#dismiss-L {background: hsl(102.5deg 15.2% 50%);}
#splash button#dismiss-N {background: hsl(0deg 84.8% 50%);}
</style>
<footer class="global">
	<b></b>
	<div>
		<a href="/wpewebkit.org/update-11ty/" class="igalia logo home"><img src="/wpewebkit.org/update-11ty/assets/img/logo-white.svg" alt="WPE"></a>
		<ul>
			<li>Connect on <a rel="me" href="https://floss.social/@WPEWebKit">Mastodon</a>, <a href="https://twitter.com/WPEWebKit">Twitter</a></li>
			<li>mailing list: <a href="https://lists.webkit.org/mailman/listinfo/webkit-wpe">webkit-wpe</a></li>
			<li>OFTC: <a href="https://webchat.oftc.net/?channels=wpe">#wpe</a></li>
			<li>Matrix: <a href="https://matrix.to/#/#wpe:matrix.org">#wpe:matrix.org</a></li>
		</ul>
		<ul>
			<li>Copyright &copy; 2018-2024 The WPE WebKit Team.</li>
			<li>Hosting kindly provided by <a href="https://www.igalia.com">Igalia</a>.</li>
			<li><a href="/wpewebkit.org/update-11ty/sitemap/">Site map</a>.</li>
		</ul>
	</div>
</footer>
<script>
let storedInfo = {};
const flagName = 'survey-splash';

function startup(flagName) {
	if (!flagName) {
		console.error('Missing flagName');
		return;
	}
	if (storageAvailable("localStorage")) {
		let currentTime = Date.now();
		let timeOut = 1;
		timeOut *= 86400 * 1000;
		let localStore = localStorage.getItem(flagName);
		if (!localStore) {
			storedInfo = {
				'status': null,
				'datetime': currentTime,
				'pageloads' : 0
			}
		} else {
			storedInfo = JSON.parse(localStore);
		}
		storedInfo.pageloads++;
		localStorage.setItem(flagName, JSON.stringify(storedInfo));

		if (storedInfo.pageloads < 11) return;
		if (storedInfo.status == "Y" || storedInfo.status == "N") return;
		if (storedInfo.status && currentTime - storedInfo.datetime < timeOut) return;

		splash.showModal();
		storedInfo.datetime = currentTime;
	}
}

function storageAvailable(type) {
	// https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
  let storage;
  try {
    storage = window[type];
    const x = "__storage_test__";
    storage.setItem(x, x);
    storage.removeItem(x);
    return true;
  } catch (e) {
    return (
      e instanceof DOMException &&
      // everything except Firefox
      (e.code === 22 ||
        // Firefox
        e.code === 1014 ||
        // test name field too, because code might not be present
        // everything except Firefox
        e.name === "QuotaExceededError" ||
        // Firefox
        e.name === "NS_ERROR_DOM_QUOTA_REACHED") &&
      // acknowledge QuotaExceededError only if there's something already stored
      storage &&
      storage.length !== 0
    );
  }
}

function surveyRedirect() {
	let surveyURL = "https://docs.google.com/forms/d/e/1FAIpQLSchPgMGzuVc9ry5bdxF2uFnW2q3FcrSSqxJdOM4Fd2BD4s7dg/viewform?usp=pp_url&entry.1179679285=WPEWebKit.org+website";	
	if (surveyURL) window.location = surveyURL;
}

document.querySelectorAll('button[is="dis-misser"]').forEach(el => {
	el.addEventListener("click", () => {
		splash.close();
		storedInfo.status = el.getAttribute('id').replace('dismiss-','');
		console.log(storedInfo);
		localStorage.setItem(flagName, JSON.stringify(storedInfo));
		if (storedInfo.status == "Y") surveyRedirect();
	});
});

window.onload = startup(flagName);
</script>


  </body>
</html>
